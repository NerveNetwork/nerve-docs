<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NerveDEX设计文档 | NerveNetwork</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="分布式数字资产服务网络">
    
    <link rel="preload" href="/assets/css/0.styles.f6430356.css" as="style"><link rel="preload" href="/assets/js/app.d4be41a6.js" as="script"><link rel="preload" href="/assets/js/2.ca2d5d49.js" as="script"><link rel="preload" href="/assets/js/92.ee6a581c.js" as="script"><link rel="prefetch" href="/assets/js/10.c32cf779.js"><link rel="prefetch" href="/assets/js/100.d9b3e275.js"><link rel="prefetch" href="/assets/js/101.e4af1a85.js"><link rel="prefetch" href="/assets/js/102.a9dd770d.js"><link rel="prefetch" href="/assets/js/103.ba0b30a9.js"><link rel="prefetch" href="/assets/js/104.b7c49a7a.js"><link rel="prefetch" href="/assets/js/105.efa67c68.js"><link rel="prefetch" href="/assets/js/106.a72084f2.js"><link rel="prefetch" href="/assets/js/107.c260a8db.js"><link rel="prefetch" href="/assets/js/108.a9c9a962.js"><link rel="prefetch" href="/assets/js/109.27bd93fe.js"><link rel="prefetch" href="/assets/js/11.9c960706.js"><link rel="prefetch" href="/assets/js/110.d947b497.js"><link rel="prefetch" href="/assets/js/111.7bfb023a.js"><link rel="prefetch" href="/assets/js/112.05357379.js"><link rel="prefetch" href="/assets/js/113.07f06902.js"><link rel="prefetch" href="/assets/js/114.b1748966.js"><link rel="prefetch" href="/assets/js/115.b66b93c8.js"><link rel="prefetch" href="/assets/js/116.c43ac283.js"><link rel="prefetch" href="/assets/js/117.5b2f8f14.js"><link rel="prefetch" href="/assets/js/118.173e0351.js"><link rel="prefetch" href="/assets/js/119.7a04451e.js"><link rel="prefetch" href="/assets/js/12.2067fc9e.js"><link rel="prefetch" href="/assets/js/120.5bad6a2c.js"><link rel="prefetch" href="/assets/js/121.afec5b40.js"><link rel="prefetch" href="/assets/js/122.221a949c.js"><link rel="prefetch" href="/assets/js/123.22a1758c.js"><link rel="prefetch" href="/assets/js/124.b672753a.js"><link rel="prefetch" href="/assets/js/125.9016ebda.js"><link rel="prefetch" href="/assets/js/126.77e6a7dc.js"><link rel="prefetch" href="/assets/js/127.fd59711a.js"><link rel="prefetch" href="/assets/js/128.3279ca6b.js"><link rel="prefetch" href="/assets/js/129.d63c964a.js"><link rel="prefetch" href="/assets/js/13.418f909d.js"><link rel="prefetch" href="/assets/js/130.f1ca0e8a.js"><link rel="prefetch" href="/assets/js/131.b93810a7.js"><link rel="prefetch" href="/assets/js/132.5e8ca85a.js"><link rel="prefetch" href="/assets/js/133.530bd1a7.js"><link rel="prefetch" href="/assets/js/134.e67368d9.js"><link rel="prefetch" href="/assets/js/14.6c90124e.js"><link rel="prefetch" href="/assets/js/15.dfd97eea.js"><link rel="prefetch" href="/assets/js/16.64f7427c.js"><link rel="prefetch" href="/assets/js/17.588016f7.js"><link rel="prefetch" href="/assets/js/18.3258ff6b.js"><link rel="prefetch" href="/assets/js/19.09df0fe6.js"><link rel="prefetch" href="/assets/js/20.6a64c220.js"><link rel="prefetch" href="/assets/js/21.2bb8a9b8.js"><link rel="prefetch" href="/assets/js/22.3e213551.js"><link rel="prefetch" href="/assets/js/23.92e86e3c.js"><link rel="prefetch" href="/assets/js/24.2e77b14f.js"><link rel="prefetch" href="/assets/js/25.ba843b32.js"><link rel="prefetch" href="/assets/js/26.4feb6ce9.js"><link rel="prefetch" href="/assets/js/27.731cad97.js"><link rel="prefetch" href="/assets/js/28.ea7b8483.js"><link rel="prefetch" href="/assets/js/29.e2ca3c14.js"><link rel="prefetch" href="/assets/js/3.7b00601b.js"><link rel="prefetch" href="/assets/js/30.2e0bf148.js"><link rel="prefetch" href="/assets/js/31.161e83a7.js"><link rel="prefetch" href="/assets/js/32.7cc311cb.js"><link rel="prefetch" href="/assets/js/33.85e0658c.js"><link rel="prefetch" href="/assets/js/34.0015676a.js"><link rel="prefetch" href="/assets/js/35.87638dd5.js"><link rel="prefetch" href="/assets/js/36.3b165788.js"><link rel="prefetch" href="/assets/js/37.110592b5.js"><link rel="prefetch" href="/assets/js/38.b36f3a96.js"><link rel="prefetch" href="/assets/js/39.af1a9490.js"><link rel="prefetch" href="/assets/js/4.5f2fb46f.js"><link rel="prefetch" href="/assets/js/40.a1f6e37f.js"><link rel="prefetch" href="/assets/js/41.24c58075.js"><link rel="prefetch" href="/assets/js/42.6be68f58.js"><link rel="prefetch" href="/assets/js/43.ed2376ef.js"><link rel="prefetch" href="/assets/js/44.6d76c935.js"><link rel="prefetch" href="/assets/js/45.0464061a.js"><link rel="prefetch" href="/assets/js/46.db214e3f.js"><link rel="prefetch" href="/assets/js/47.788b5c9e.js"><link rel="prefetch" href="/assets/js/48.5b564f6d.js"><link rel="prefetch" href="/assets/js/49.1076ef2f.js"><link rel="prefetch" href="/assets/js/5.4374b5b4.js"><link rel="prefetch" href="/assets/js/50.c4711f23.js"><link rel="prefetch" href="/assets/js/51.9aef5843.js"><link rel="prefetch" href="/assets/js/52.e61c679f.js"><link rel="prefetch" href="/assets/js/53.d50b249b.js"><link rel="prefetch" href="/assets/js/54.ab85c71b.js"><link rel="prefetch" href="/assets/js/55.960e846c.js"><link rel="prefetch" href="/assets/js/56.3a003f6b.js"><link rel="prefetch" href="/assets/js/57.fb08a791.js"><link rel="prefetch" href="/assets/js/58.c562f17a.js"><link rel="prefetch" href="/assets/js/59.9467799c.js"><link rel="prefetch" href="/assets/js/6.3302af4f.js"><link rel="prefetch" href="/assets/js/60.8fc87578.js"><link rel="prefetch" href="/assets/js/61.b8678c18.js"><link rel="prefetch" href="/assets/js/62.355fc414.js"><link rel="prefetch" href="/assets/js/63.aa5c6e36.js"><link rel="prefetch" href="/assets/js/64.6af0d539.js"><link rel="prefetch" href="/assets/js/65.e625a4d9.js"><link rel="prefetch" href="/assets/js/66.2bf97769.js"><link rel="prefetch" href="/assets/js/67.e0380a5b.js"><link rel="prefetch" href="/assets/js/68.64dad02c.js"><link rel="prefetch" href="/assets/js/69.e4fa65e8.js"><link rel="prefetch" href="/assets/js/7.d0968138.js"><link rel="prefetch" href="/assets/js/70.dee37f55.js"><link rel="prefetch" href="/assets/js/71.4ba61459.js"><link rel="prefetch" href="/assets/js/72.4b00f6a9.js"><link rel="prefetch" href="/assets/js/73.13bf7bee.js"><link rel="prefetch" href="/assets/js/74.364c309a.js"><link rel="prefetch" href="/assets/js/75.ad8bc8d5.js"><link rel="prefetch" href="/assets/js/76.9891bcee.js"><link rel="prefetch" href="/assets/js/77.c0297a98.js"><link rel="prefetch" href="/assets/js/78.008c77cf.js"><link rel="prefetch" href="/assets/js/79.0738da50.js"><link rel="prefetch" href="/assets/js/8.c1cf4020.js"><link rel="prefetch" href="/assets/js/80.49f9297f.js"><link rel="prefetch" href="/assets/js/81.956ea280.js"><link rel="prefetch" href="/assets/js/82.024d26b9.js"><link rel="prefetch" href="/assets/js/83.02cd5815.js"><link rel="prefetch" href="/assets/js/84.49d78d71.js"><link rel="prefetch" href="/assets/js/85.20b5b837.js"><link rel="prefetch" href="/assets/js/86.3d208765.js"><link rel="prefetch" href="/assets/js/87.7235eaa1.js"><link rel="prefetch" href="/assets/js/88.306cf41e.js"><link rel="prefetch" href="/assets/js/89.39da7e05.js"><link rel="prefetch" href="/assets/js/9.6597d3fa.js"><link rel="prefetch" href="/assets/js/90.b272667a.js"><link rel="prefetch" href="/assets/js/91.2c691c58.js"><link rel="prefetch" href="/assets/js/93.8001e2b7.js"><link rel="prefetch" href="/assets/js/94.b116cf7f.js"><link rel="prefetch" href="/assets/js/95.6f3ae764.js"><link rel="prefetch" href="/assets/js/96.6d907f61.js"><link rel="prefetch" href="/assets/js/97.53127fb1.js"><link rel="prefetch" href="/assets/js/98.fd8e80f1.js"><link rel="prefetch" href="/assets/js/99.39ec2257.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f6430356.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">NerveNetwork</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/Guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/Docs/" class="nav-link router-link-active">
  开发
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Docs/dex_design.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/Docs/dex_design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/NerveNetwork/nerve-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/Guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/Docs/" class="nav-link router-link-active">
  开发
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Docs/dex_design.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/Docs/dex_design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/NerveNetwork/nerve-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>NerveDEX</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/Docs/dex_design.html" aria-current="page" class="active sidebar-link">NerveDEX设计文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#模块运行环境" class="sidebar-link">模块运行环境</a></li><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#模块配置说明" class="sidebar-link">模块配置说明</a></li><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#模块协议说明" class="sidebar-link">模块协议说明</a></li><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#功能描述" class="sidebar-link">功能描述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#dex模块功能需求说明" class="sidebar-link">DEX模块功能需求说明</a></li><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#整体功能流程图" class="sidebar-link">整体功能流程图</a></li><li class="sidebar-sub-header"><a href="/zh/Docs/dex_design.html#模块内部功能" class="sidebar-link">模块内部功能</a></li></ul></li></ul></li><li><a href="/zh/Docs/dex_api.html" class="sidebar-link">NerveDEX-API</a></li><li><a href="/zh/Docs/dex_module.html" class="sidebar-link">NerveDEX模块</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nervedex设计文档"><a href="#nervedex设计文档" class="header-anchor">#</a> NerveDEX设计文档</h1> <h2 id="模块运行环境"><a href="#模块运行环境" class="header-anchor">#</a> 模块运行环境</h2> <ul><li>jdk: 11</li> <li>ide: IntelliJ IDEA 2020.3.3 (Community Edition)</li> <li>maven: 3.3.9</li></ul> <h2 id="模块配置说明"><a href="#模块配置说明" class="header-anchor">#</a> 模块配置说明</h2> <p>配置文件路径：module.ncf</p> <table><thead><tr><th>配置项</th> <th>说明</th></tr></thead> <tbody><tr><td>sysFeeAddress</td> <td>订单成交后，系统收取手续费的地址</td></tr> <tr><td>sysFeeScale</td> <td>系统收取手续费比例（sysFeeScale=3，表示3/10000）</td></tr> <tr><td>createTradingAmount</td> <td>用户创建资产交易对手续费用</td></tr></tbody></table> <h2 id="模块协议说明"><a href="#模块协议说明" class="header-anchor">#</a> 模块协议说明</h2> <p><strong>创建交易对协议(CoinTrading)</strong></p> <p>说明：</p> <ol><li><strong>scaleBaseDecimal：交易资产允许最小交易小数位</strong>。用比特币来举例，比特币的小数为8位，即 1BTC = 10^8聪。而在实际交易的时候，我们并不需要支持这么小的单位来做交易，例如我们只想支持小数位到6位，在创建交易对的时候scaleBaseDecimal填写为6即可。scaleQuoteDecimal字段含义一样。注：scaleBaseDecimal填写数值不能大于资产本身的小数位。</li> <li>**minBaseAmount：交易资产最小交易单位。**最小交易单位，受最小交易小数位制约。例如，BTC我们只支持小数为到6位，那最小交易单位填写数值就必须&gt;=100聪。</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>23</td> <td>address</td> <td>byte[]</td> <td>交易对创建人</td></tr> <tr><td>4</td> <td>baseAssetChainId</td> <td>uint</td> <td>交易币种的链Id</td></tr> <tr><td>4</td> <td>baseAssetId</td> <td>uint</td> <td>交易币种的资产Id</td></tr> <tr><td>1</td> <td>scaleBaseDecimal</td> <td>byte</td> <td>交易币种允许最小交易小数位</td></tr> <tr><td>8</td> <td>minBaseAmount</td> <td>bigInteger</td> <td>交易币种最小交易单位</td></tr> <tr><td>4</td> <td>quoteAssetChainId</td> <td>uint</td> <td>计价币种的链Id</td></tr> <tr><td>4</td> <td>quoteAssetId</td> <td>uint</td> <td>计价币种的资产Id</td></tr> <tr><td>1</td> <td>scaleQuoteDecimal</td> <td>byte</td> <td>计价币种允许最小交易小数位</td></tr> <tr><td>8</td> <td>minQuoteAmount</td> <td>bigInteger</td> <td>计价币种最小交易单位</td></tr></tbody></table> <p><strong>修改资产交易对交易协议(EditCoinTrading)</strong></p> <p>说明：</p> <ol><li>修改资产交易对交易只允许资产交易对创建人发起。</li> <li>只允许修改最小支持交易小数位和最小交易单位。</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>tradingHash</td> <td>byte[]</td> <td>资产交易对hash</td></tr> <tr><td>1</td> <td>scaleBaseDecimal</td> <td>byte</td> <td>交易币种允许最小交易小数位</td></tr> <tr><td>1</td> <td>scaleQuoteDecimal</td> <td>byte</td> <td>计价币种允许最小交易小数位</td></tr> <tr><td>8</td> <td>minBaseAmount</td> <td>bigInteger</td> <td>交易币种最小交易单位</td></tr> <tr><td>8</td> <td>minQuoteAmount</td> <td>bigInteger</td> <td>计价币种最小交易单位</td></tr></tbody></table> <p><strong>资产交易对交易委托挂单协议(TradingOrder)</strong></p> <p>说明：</p> <ol><li><strong>feeAddress：收取服务费地址</strong>。用户在去中心化交易所服务节点发起委托挂单的时候，节点可配置一个NVT地址作为服务费收取地址。当用户委托单成交后，该地址会收取成交额一定比例作为服务手续费。若节点未配置地址，则视为不收取服务费。</li> <li>**feeScale：收取服务费比例。**feeScale和feeAddress配套使用。当feeAddress为空时，feeScale取值必须为0；当feeAddress不为空时，feeScale取值1-5，表示收取成交额的1/10000~5/10000作为服务费。</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>tradingHash</td> <td>byte[]</td> <td>资产交易对hash</td></tr> <tr><td>23</td> <td>address</td> <td>byte[]</td> <td>委托挂单账户地址</td></tr> <tr><td>1</td> <td>type</td> <td>byte</td> <td>1：买单，2：卖单</td></tr> <tr><td>8</td> <td>amount</td> <td>bigInteger</td> <td>委托挂单数量（交易币种数量）</td></tr> <tr><td>8</td> <td>price</td> <td>bigInteger</td> <td>委托挂单价格</td></tr> <tr><td>？</td> <td>feeAddress</td> <td>byte[]</td> <td>收取服务费地址（可为空）</td></tr> <tr><td>1</td> <td>feeScale</td> <td>byte</td> <td>收取服务费比例，取值0-5</td></tr></tbody></table> <p><strong>撤销委托挂单协议(TradingOrderCancel)</strong></p> <p>说明：</p> <ol><li>用户发送撤销挂单时，不能指定撤销部分委托。例如：委托够买10个BTC，不能撤销部分委托只购买5个BTC，只能是订单全部撤销。</li> <li>用户发送撤销挂单后，最后撤销数量由节点打包时做最后确认。（详细说明见：NerveDEX说明文档）</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>orderHash</td> <td>byte[]</td> <td>挂单交易hash</td></tr></tbody></table> <p><strong>成交协议(TradingDeal)</strong></p> <p>说明：</p> <ol><li>用户支付的手续费 = 系统收取手续费（固定为成交额的3/10000） + 交易所服务节点手续费（成交额的0 ~ 5/10000）</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>tradingHash</td> <td>byte[]</td> <td>资产交易对hash</td></tr> <tr><td>32</td> <td>buyHash</td> <td>byte[]</td> <td>委托买单交易hash</td></tr> <tr><td>8</td> <td>buyNonce</td> <td>byte[]</td> <td>委托买单nonce值</td></tr> <tr><td>32</td> <td>sellHash</td> <td>byte[]</td> <td>委托卖单交易hash</td></tr> <tr><td>8</td> <td>sellNonce</td> <td>byte[]</td> <td>委托卖单nonce值</td></tr> <tr><td>8</td> <td>quoteAmount</td> <td>bigInteger</td> <td>成交总额</td></tr> <tr><td>8</td> <td>baseAmount</td> <td>bigInteger</td> <td>成交总量</td></tr> <tr><td>8</td> <td>buyFee</td> <td>bigInteger</td> <td>买家支付手续费</td></tr> <tr><td>8</td> <td>sellFee</td> <td>bigInteger</td> <td>卖家支付手续费</td></tr> <tr><td>8</td> <td>price</td> <td>bigInteger</td> <td>成交价</td></tr> <tr><td>1</td> <td>taker</td> <td>byte</td> <td>主动成交方: 1 买单主动吃单，2 卖单主动吃单</td></tr> <tr><td>1</td> <td>type</td> <td>byte</td> <td>成交状态: 1 买单已完全成交，2 卖单已完全成交，3 买卖双方都完全成交</td></tr></tbody></table> <p><strong>取消委托确认协议(CancelDeal)</strong></p> <p>说明：</p> <ol><li><strong>status:撤销确认结果</strong>。共识节点在打包区块时，若先于打包用户的撤销交易前，打包了一个新的委托挂单交易，恰好委托挂单能和匹配撮合。这时需先处理撮合成交交易。撮合完成后，若挂单已完全成交，则此次撤销则为失败。反之，若订单只有部分金额撮合成功，或未匹配撮合，则此次撤销成功。</li> <li>无论最终的撤销确认是否成功，用户发送的原始撤销挂单交易都会被打包到区块中，作为凭证。</li></ol> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>cancelHash</td> <td>byte[]</td> <td>用户发起的撤销委托交易hash</td></tr> <tr><td>32</td> <td>orderHash</td> <td>byte[]</td> <td>原始委托挂单交易hash</td></tr> <tr><td>1</td> <td>status</td> <td>byte</td> <td>撤销确认结果: 0 撤销失败  1撤销成功</td></tr> <tr><td>8</td> <td>cancelAmount</td> <td>bigInteger</td> <td>最终确认撤销金额</td></tr></tbody></table> <h2 id="功能描述"><a href="#功能描述" class="header-anchor">#</a> 功能描述</h2> <h3 id="dex模块功能需求说明"><a href="#dex模块功能需求说明" class="header-anchor">#</a> DEX模块功能需求说明</h3> <p>目标：实现一个去中心化的资产交易对交易系统。</p> <p>需实现功能：</p> <ul><li>其他链的加密资产能够转入NerveDEX模块，且支持资产在链内的流通，转账数据能够上链。</li> <li>能够创建资产交易对，且资产交易对的信息能够上链。</li> <li>用户能够委托挂单，也能够委托撤销挂单。挂单和撤单数据能够上链。</li> <li>委托挂单能够撮合成交，且有严格公平的撮合机制。且最终的撮合数据能够上链，接受全网监督。</li> <li>有可视化的交易界面，提供交易对查询、交易对最新价格展示、交易对K线图展示、交易对盘口展示、最新成交记录展示。</li> <li>有可视化的交易界面，用户可直接挂单买入或者卖出、查看当前委托单信息、撤销委托单、查看用户历史委托记录和成交记录。</li></ul> <p>实现方式：</p> <ul><li><p>他链的加密资产转入到Nerve链来，这个通过NULS生态的跨链模块已实现。NULS链本身就支持生态内的跨链转账，且独有的异构跨链网络，也已实现将其他公链的加密资产转入NULS生态内（目前暂支持ETH和ERC20）。相信资料详见NULS跨链模块文档。</p></li> <li><p>在区块链底层添加交易所运行流程必需的交易协议（交易对创建、用户委托订单、用户撤销委托单、委托单撮合成交）；</p></li> <li><p>添加各个协议的验证器。验证器严格规范了交易数据验证流程，只有验证通过的交易协议才允许上链；</p></li> <li><p>数据的维护与处理。数据的维护与处理包括三块：</p> <ol><li>区块打包：共识节点打包区块时，需要将盘口维护的已有挂单与新打包的挂单做撮合匹配生成成交协议，撮合匹配这一步严格意义上来说也包括协议验证，因为每个节点打包生成的成交协议，也会被其他节点验证。若验证失败，区块被拒收。</li> <li>区块存储：区块存储实际是将已被链上确认的交易数据持久化到本地。DEX模块在存储交易信息时，会先更新维护的盘口数据，再将更新后的数据做持久化存储。</li></ol></li> <li><p>提供可视化界面，方便用户挂单进行买卖操作等功能由附属模块NerveDEX-API模块提供。（详见DEX-API功能文档）。</p></li></ul> <h3 id="整体功能流程图"><a href="#整体功能流程图" class="header-anchor">#</a> 整体功能流程图</h3> <p><img src="C:%5CUsers%5CAdministrator%5CDesktop%5C%E6%96%87%E6%A1%A3%5CDEX-API%E6%96%87%E6%A1%A3%5Cpic%5CDEX-API-1.png" alt=""></p> <h3 id="模块内部功能"><a href="#模块内部功能" class="header-anchor">#</a> 模块内部功能</h3> <h4 id="模块的启动与初始化-dexbootstrap"><a href="#模块的启动与初始化-dexbootstrap" class="header-anchor">#</a> 模块的启动与初始化（DexBootstrap）</h4> <p>加载配置文件</p> <p>加载模块依赖关系</p> <p>初始化DEX模块持久化表结构</p> <p>启动模块定时任务（模块会定期调用账本模块接口查询当前Nerve链已有的他链币信息）</p> <p>加载DEX模块已有数据（包括资产交易对信息、用户挂单委托信息），通过这些数据创建资产交易对盘口，并将委托单数据放入盘口维护资产交易对交易验证与存储</p> <h4 id="创建资产交易对cointrading"><a href="#创建资产交易对cointrading" class="header-anchor">#</a> 创建资产交易对CoinTrading</h4> <p>用户发起并广播创建资产交易对交易</p> <p>节点收到并验证交易信息，见CoinTradingProcessor.validate()</p> <p>打包交易到区块</p> <p>区块验证通过后，存储资产交易对交易，见CoinTradingProcessor.coinTradingCommit()</p> <ul><li>持久化资产交易对信息</li> <li>创建资产交易对盘口</li></ul> <h4 id="资产交易对信息修改editcointrading"><a href="#资产交易对信息修改editcointrading" class="header-anchor">#</a> 资产交易对信息修改EditCoinTrading</h4> <p>用户发起并广播修改资产交易对交易</p> <p>节点收到并验证交易信息，见EditCoinTradingProcessor.validate()</p> <p>打包交易到区块</p> <p>区块验证通过后，存储资产交易对交易，见EditCoinTradingProcessor.editCoinTradingCommit()</p> <ul><li>持久化资产交易对修改信息</li> <li>修改资产交易对盘口信息</li></ul> <h4 id="用户委托挂单tradingorder"><a href="#用户委托挂单tradingorder" class="header-anchor">#</a> 用户委托挂单TradingOrder</h4> <p>用户发起并广播委托挂单交易</p> <p>节点收到并验证交易信息，见TradingOrderProcessor.validate()</p> <p>打包交易到区块</p> <p>区块验证通过后，存储委托单交易，见TradingOrderProcessor.coinTradingCommit()</p> <ul><li>持久化委托单数据</li> <li>将委托单数据放入盘口维护，并按照规则排序，见TradingContainer.addTradingOrder()</li></ul> <h4 id="用户撤销委托tradingordercancel"><a href="#用户撤销委托tradingordercancel" class="header-anchor">#</a> 用户撤销委托TradingOrderCancel</h4> <p>用户发起并广播撤销委托挂单交易</p> <p>节点收到并验证交易信息，见OrderCancelProcessor.validate()</p> <p>打包交易到区块</p> <p>区块验证通过后，存储撤销委托单交易</p> <h4 id="共识节点打包dex-api模块交易-dex-apitxpackageprocessor-packproduce"><a href="#共识节点打包dex-api模块交易-dex-apitxpackageprocessor-packproduce" class="header-anchor">#</a> 共识节点打包DEX-API模块交易（DEX-APITxPackageProcessor.packProduce()）</h4> <p>共识节点打包DEX-API模块交易时，会依次将区块内的委托单交易和当前盘口内已维护的挂单交易，尝试匹配撮合生成成交交易。若有用户申请撤销委托，打包时也会根据交易顺序，最终确定用户委托单是否可以撤销，以及可撤销挂单的具体数量。最终将此次打包的所有用户撤销委托申请，汇总生成一条撤销确认交易。生成的成交交易和撤销确认交易会一并打包到区块里。目前一次区块打包最多可确认200个成交交易。如果有新的挂单一次性吃掉盘口的挂单超过200个，则超出的部分会再下次区块出块时优先确认成交。</p> <p><img src="C:%5CUsers%5CAdministrator%5CDesktop%5C%E6%96%87%E6%A1%A3%5CDEX-API%E6%96%87%E6%A1%A3%5Cpic%5CDEX-API-2.png" alt=""></p> <h4 id="区块确认"><a href="#区块确认" class="header-anchor">#</a> 区块确认</h4> <p>节点在接收到新的区块时，首先要对区块内的所有交易进行验证，验证通过后才能持久化存储。DEX-API模块的交易确认和其他模块不同，在批量验证交易时，会根据顺序依次验证委托挂单和撤销委托单。再像打包区块时一样，将新的委托单和盘口已有挂单进行匹配，生成成交交易。最后将生成的成交交易和区块打包的成交交易一一比对，必须要交易数量和成交金额完全一致才能最终确认区块的合法性，并进行持久化存储和更新盘口。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NerveNetwork/nerve-docs/edit/master/docs/zh/Docs/dex_design.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2020-9-4 4:35:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/zh/Docs/dex_api.html">
        NerveDEX-API
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d4be41a6.js" defer></script><script src="/assets/js/2.ca2d5d49.js" defer></script><script src="/assets/js/92.ee6a581c.js" defer></script>
  </body>
</html>
